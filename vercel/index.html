<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lexie - WSJT-X Country Spotter</title>
  <script src="https://unpkg.com/mqtt@5/dist/mqtt.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #0a0e17;
      color: #e0e0e0;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #1a1f35, #0d1220);
      border-bottom: 1px solid #2a3a5c;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      color: #7eb8ff;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-group label {
      font-size: 0.8rem;
      color: #8899bb;
    }

    .control-group select {
      background: #1a2240;
      color: #e0e0e0;
      border: 1px solid #2a3a5c;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .control-group select:focus {
      outline: 2px solid #4a8aff;
      outline-offset: 1px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ff4444;
      transition: background 0.3s;
    }

    .status-dot.connected { background: #44ff88; }

    button.test-btn {
      background: #2a3a5c;
      color: #e0e0e0;
      border: 1px solid #3a4a6c;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    button.test-btn:hover { background: #3a4a6c; }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    .stats {
      display: flex;
      gap: 24px;
      padding: 10px 24px;
      background: #0d1220;
      border-bottom: 1px solid #1a2540;
      font-size: 0.9rem;
      flex-wrap: wrap;
    }

    .stat { color: #8899bb; }
    .stat strong { color: #7eb8ff; font-size: 1.1rem; }

    .container {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 0;
      height: calc(100vh - 110px);
    }

    .countries-panel {
      padding: 16px;
      overflow-y: auto;
    }

    .countries-panel h2 {
      font-size: 1rem;
      color: #8899bb;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .country-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .country-card {
      background: linear-gradient(135deg, #151c30, #1a2240);
      border: 1px solid #2a3a5c;
      border-radius: 8px;
      padding: 10px 14px;
      min-width: 160px;
      transition: all 0.3s;
      animation: fadeIn 0.4s ease-out;
    }

    .country-card.highlight {
      border-color: #4a8aff;
      box-shadow: 0 0 16px rgba(74, 138, 255, 0.3);
    }

    .country-card .name {
      font-weight: 600;
      font-size: 0.95rem;
      color: #e8f0ff;
    }

    .country-card .meta {
      font-size: 0.75rem;
      color: #667799;
      margin-top: 4px;
    }

    .country-card .count {
      display: inline-block;
      background: #2a3a5c;
      color: #7eb8ff;
      border-radius: 10px;
      padding: 1px 8px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 6px;
    }

    .feed-panel {
      background: #0d1220;
      border-left: 1px solid #1a2540;
      display: flex;
      flex-direction: column;
    }

    .feed-panel h2 {
      font-size: 1rem;
      color: #8899bb;
      padding: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid #1a2540;
    }

    .feed-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .feed-item {
      padding: 8px 12px;
      border-bottom: 1px solid #131a2e;
      animation: slideIn 0.3s ease-out;
    }

    .feed-item .time {
      font-size: 0.7rem;
      color: #556688;
      font-family: monospace;
    }

    .feed-item .content {
      font-size: 0.85rem;
      margin-top: 2px;
    }

    .feed-item .country-name {
      color: #7eb8ff;
      font-weight: 600;
    }

    .feed-item .callsign {
      color: #ffcc44;
      font-family: monospace;
      font-weight: 500;
    }

    .feed-item .band-tag {
      font-size: 0.7rem;
      color: #44ddaa;
      font-family: monospace;
    }

    .feed-item .snr-tag {
      font-size: 0.7rem;
      color: #888;
      font-family: monospace;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #445577;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: #556699;
    }

    .empty-state p {
      font-size: 0.9rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 300px;
      }
      .feed-panel { border-left: none; border-top: 1px solid #1a2540; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Lexie - WSJT-X Country Spotter</h1>
    <div class="header-controls">
      <div class="control-group">
        <label for="bandSelect">Band:</label>
        <select id="bandSelect" aria-label="Band filter">
          <option value="all">All bands</option>
          <option value="160m">160m</option>
          <option value="80m">80m</option>
          <option value="60m">60m</option>
          <option value="40m">40m</option>
          <option value="30m">30m</option>
          <option value="20m" selected>20m</option>
          <option value="17m">17m</option>
          <option value="15m">15m</option>
          <option value="12m">12m</option>
          <option value="10m">10m</option>
          <option value="6m">6m</option>
          <option value="2m">2m</option>
        </select>
      </div>
      <div class="control-group">
        <label for="modeSelect">Mode:</label>
        <select id="modeSelect" aria-label="Mode filter">
          <option value="all">All modes</option>
          <option value="FT8" selected>FT8</option>
          <option value="FT4">FT4</option>
          <option value="WSPR">WSPR</option>
          <option value="JS8">JS8</option>
          <option value="MSK144">MSK144</option>
        </select>
      </div>
      <div class="control-group">
        <label for="voiceMode">Announce:</label>
        <select id="voiceMode" aria-label="Voice announcement mode">
          <option value="off">Off</option>
          <option value="self-voice">Self-voice (TTS)</option>
          <option value="screen-reader">Screen reader</option>
        </select>
        <button class="test-btn" id="testVoice" aria-label="Test voice announcement">Test</button>
      </div>
      <div class="status">
        <div class="status-dot" id="statusDot" role="status" aria-label="Connection status"></div>
        <span id="statusText">Disconnected</span>
      </div>
    </div>
  </header>

  <div id="srAnnounce" class="sr-only" aria-live="polite" aria-atomic="true" role="log"
       aria-label="New country announcements"></div>

  <div class="stats">
    <div class="stat">Countries: <strong id="countryCount">0</strong></div>
    <div class="stat">Callsigns: <strong id="callsignCount">0</strong></div>
    <div class="stat">Spots: <strong id="messageCount">0</strong></div>
  </div>

  <div class="container">
    <div class="countries-panel">
      <h2>Countries Spotted</h2>
      <div class="country-grid" id="countryGrid" role="list" aria-label="Countries spotted">
        <div class="empty-state" id="emptyState">
          <h3>Connecting to PSKReporter...</h3>
          <p>Live spots will appear as they are reported worldwide</p>
        </div>
      </div>
    </div>

    <div class="feed-panel">
      <h2>Live Feed</h2>
      <div class="feed-list" id="feedList" role="log" aria-label="Live spot feed" aria-relevant="additions"></div>
    </div>
  </div>

  <script>
    // --- DXCC prefix-to-country map (inlined) ---
    const prefixMap = {
      'K':'United States','W':'United States','N':'United States','AA':'United States','AB':'United States',
      'AC':'United States','AD':'United States','AE':'United States','AF':'United States','AG':'United States',
      'AH':'United States','AI':'United States','AJ':'United States','AK':'United States','AL':'United States',
      'KA':'United States','KB':'United States','KC':'United States','KD':'United States','KE':'United States',
      'KF':'United States','KG':'United States','KH':'United States','KI':'United States','KJ':'United States',
      'KK':'United States','KL':'United States','KM':'United States','KN':'United States','KO':'United States',
      'KP':'United States','KQ':'United States','KR':'United States','KS':'United States','KT':'United States',
      'KU':'United States','KV':'United States','KW':'United States','KX':'United States','KY':'United States',
      'KZ':'United States','NA':'United States','NB':'United States','NC':'United States','ND':'United States',
      'NE':'United States','NF':'United States','NG':'United States','NH':'United States','NI':'United States',
      'NJ':'United States','NK':'United States','NL':'United States','NM':'United States','NN':'United States',
      'NO':'United States','NP':'United States','NQ':'United States','NR':'United States','NS':'United States',
      'NT':'United States','NU':'United States','NV':'United States','NW':'United States','NX':'United States',
      'NY':'United States','NZ':'United States','WA':'United States','WB':'United States','WC':'United States',
      'WD':'United States','WE':'United States','WF':'United States','WG':'United States','WH':'United States',
      'WI':'United States','WJ':'United States','WK':'United States','WL':'United States','WM':'United States',
      'WN':'United States','WO':'United States','WP':'United States','WQ':'United States','WR':'United States',
      'WS':'United States','WT':'United States','WU':'United States','WV':'United States','WW':'United States',
      'WX':'United States','WY':'United States','WZ':'United States',
      'KH0':'Mariana Islands','KH1':'Baker & Howland Islands','KH2':'Guam',
      'KH3':'Johnston Island','KH4':'Midway Island','KH5':'Palmyra & Jarvis Islands',
      'KH6':'Hawaii','KH7':'Kure Island','KH8':'American Samoa','KH9':'Wake Island',
      'KL7':'Alaska','KP1':'Navassa Island','KP2':'US Virgin Islands',
      'KP3':'Puerto Rico','KP4':'Puerto Rico','KP5':'Desecheo Island',
      'AH0':'Mariana Islands','AH2':'Guam','AH6':'Hawaii','AH8':'American Samoa',
      'AL7':'Alaska','WH6':'Hawaii','WL7':'Alaska','WP4':'Puerto Rico',
      'NH6':'Hawaii','NL7':'Alaska','NP4':'Puerto Rico',
      'VA':'Canada','VB':'Canada','VC':'Canada','VD':'Canada','VE':'Canada',
      'VF':'Canada','VG':'Canada','VO':'Canada','VX':'Canada','VY':'Canada',
      'CY':'Canada','CZ':'Canada','CF':'Canada','CG':'Canada','CH':'Canada',
      'CI':'Canada','CJ':'Canada','CK':'Canada',
      'XA':'Mexico','XB':'Mexico','XC':'Mexico','XD':'Mexico','XE':'Mexico',
      'XF':'Mexico','4A':'Mexico','4B':'Mexico','4C':'Mexico','6D':'Mexico',
      '6E':'Mexico','6F':'Mexico','6G':'Mexico','6H':'Mexico',
      'G':'England','GD':'Isle of Man','GI':'Northern Ireland','GJ':'Jersey',
      'GM':'Scotland','GU':'Guernsey','GW':'Wales','M':'England',
      '2E':'England','2D':'Isle of Man','2I':'Northern Ireland','2J':'Jersey',
      '2M':'Scotland','2U':'Guernsey','2W':'Wales',
      'F':'France','HW':'France','HX':'France','HY':'France','TH':'France',
      'TM':'France','TO':'France','TP':'France','TQ':'France','TV':'France',
      'DL':'Germany','DA':'Germany','DB':'Germany','DC':'Germany','DD':'Germany',
      'DE':'Germany','DF':'Germany','DG':'Germany','DH':'Germany','DI':'Germany',
      'DJ':'Germany','DK':'Germany','DM':'Germany','DN':'Germany','DO':'Germany',
      'DP':'Germany','DQ':'Germany','DR':'Germany',
      'I':'Italy','IA':'Italy','IB':'Italy','IC':'Italy','ID':'Italy',
      'IE':'Italy','IF':'Italy','IG':'Italy','IH':'Italy','II':'Italy',
      'IJ':'Italy','IK':'Italy','IL':'Italy','IM':'Italy','IN':'Italy',
      'IO':'Italy','IP':'Italy','IQ':'Italy','IR':'Italy','IS':'Italy',
      'IT':'Italy','IU':'Italy','IV':'Italy','IW':'Italy','IX':'Italy',
      'IY':'Italy','IZ':'Italy',
      'EA':'Spain','EB':'Spain','EC':'Spain','ED':'Spain','EE':'Spain',
      'EF':'Spain','EG':'Spain','EH':'Spain',
      'EA6':'Balearic Islands','EA8':'Canary Islands','EA9':'Ceuta & Melilla',
      'CT':'Portugal','CU':'Azores','CS':'Portugal',
      'PA':'Netherlands','PB':'Netherlands','PC':'Netherlands','PD':'Netherlands',
      'PE':'Netherlands','PF':'Netherlands','PG':'Netherlands','PH':'Netherlands',
      'PI':'Netherlands',
      'ON':'Belgium','OO':'Belgium','OP':'Belgium','OQ':'Belgium','OR':'Belgium',
      'OS':'Belgium','OT':'Belgium',
      'HB':'Switzerland','HB0':'Liechtenstein','HE':'Switzerland',
      'OE':'Austria',
      'OZ':'Denmark','OU':'Denmark','OV':'Denmark','OW':'Denmark','OX':'Greenland',
      'XP':'Greenland','OY':'Faroe Islands',
      'SM':'Sweden','SA':'Sweden','SB':'Sweden','SC':'Sweden','SD':'Sweden',
      'SE':'Sweden','SF':'Sweden','SG':'Sweden','SH':'Sweden','SI':'Sweden',
      'SJ':'Sweden','SK':'Sweden','SL':'Sweden','7S':'Sweden',
      'LA':'Norway','LB':'Norway','LC':'Norway','LD':'Norway','LE':'Norway',
      'LF':'Norway','LG':'Norway','LH':'Norway','LI':'Norway','LJ':'Norway',
      'LK':'Norway','LL':'Norway','LM':'Norway','LN':'Norway',
      'JW':'Svalbard','JX':'Jan Mayen',
      'OH':'Finland','OF':'Finland','OG':'Finland','OI':'Finland',
      'OH0':'Aland Islands',
      'SP':'Poland','SN':'Poland','SO':'Poland','SQ':'Poland','SR':'Poland',
      '3Z':'Poland','HF':'Poland',
      'OK':'Czech Republic','OL':'Czech Republic',
      'HA':'Hungary','HG':'Hungary',
      'YO':'Romania','YP':'Romania','YQ':'Romania','YR':'Romania',
      'LZ':'Bulgaria',
      'YU':'Serbia','YT':'Serbia',
      'Z3':'North Macedonia',
      '9A':'Croatia',
      'S5':'Slovenia',
      'E7':'Bosnia-Herzegovina',
      '4O':'Montenegro',
      'ZA':'Albania',
      'SV':'Greece','SW':'Greece','SX':'Greece','SY':'Greece','SZ':'Greece',
      'J4':'Greece',
      'SV5':'Dodecanese','SV9':'Crete',
      'TA':'Turkey','TB':'Turkey','TC':'Turkey',
      'YL':'Latvia',
      'LY':'Lithuania',
      'ES':'Estonia',
      'UR':'Ukraine','US':'Ukraine','UT':'Ukraine','UU':'Ukraine','UV':'Ukraine',
      'UW':'Ukraine','UX':'Ukraine','UY':'Ukraine','UZ':'Ukraine',
      'EU':'Belarus','EV':'Belarus','EW':'Belarus',
      'ER':'Moldova',
      'UA':'Russia','UB':'Russia','UC':'Russia','UD':'Russia','UE':'Russia',
      'UF':'Russia','UG':'Russia','UH':'Russia','UI':'Russia',
      'RA':'Russia','RB':'Russia','RC':'Russia','RD':'Russia','RE':'Russia',
      'RF':'Russia','RG':'Russia','RH':'Russia','RI':'Russia','RJ':'Russia',
      'RK':'Russia','RL':'Russia','RM':'Russia','RN':'Russia','RO':'Russia',
      'RP':'Russia','RQ':'Russia','RR':'Russia','RS':'Russia','RT':'Russia',
      'RU':'Russia','RV':'Russia','RW':'Russia','RX':'Russia','RY':'Russia',
      'RZ':'Russia','R':'Russia','U':'Russia',
      'UA2':'Kaliningrad',
      'EI':'Ireland','EJ':'Ireland',
      'TF':'Iceland',
      'LX':'Luxembourg',
      '9H':'Malta',
      '4U1V':'Vienna Intl Centre',
      'JY':'Jordan',
      'LU':'Argentina','LO':'Argentina','LP':'Argentina','LQ':'Argentina',
      'LR':'Argentina','LS':'Argentina','LT':'Argentina','LV':'Argentina',
      'LW':'Argentina','AY':'Argentina','AZ':'Argentina','L2':'Argentina',
      'L3':'Argentina','L4':'Argentina','L5':'Argentina','L6':'Argentina',
      'L7':'Argentina','L8':'Argentina','L9':'Argentina',
      'PY':'Brazil','PP':'Brazil','PQ':'Brazil','PR':'Brazil','PS':'Brazil',
      'PT':'Brazil','PU':'Brazil','PV':'Brazil','PW':'Brazil','PX':'Brazil',
      'ZV':'Brazil','ZW':'Brazil','ZX':'Brazil','ZY':'Brazil','ZZ':'Brazil',
      'CE':'Chile','CA':'Chile','CB':'Chile','CC':'Chile','CD':'Chile',
      'XQ':'Chile','XR':'Chile','3G':'Chile',
      'CE0Y':'Easter Island','CE0Z':'Juan Fernandez Islands','CE0X':'San Felix Islands',
      'HK':'Colombia','HJ':'Colombia','5J':'Colombia','5K':'Colombia',
      'HC':'Ecuador','HD':'Ecuador',
      'HC8':'Galapagos Islands',
      'OA':'Peru','OB':'Peru','OC':'Peru',
      'YV':'Venezuela','YW':'Venezuela','YX':'Venezuela','YY':'Venezuela',
      '4M':'Venezuela',
      'CP':'Bolivia',
      'ZP':'Paraguay',
      'CX':'Uruguay','CV':'Uruguay','CW':'Uruguay',
      '9Y':'Trinidad & Tobago',
      '8R':'Guyana',
      'PZ':'Suriname',
      'PJ2':'Curacao','PJ4':'Bonaire','PJ5':'Sint Eustatius','PJ6':'Saba',
      'PJ7':'Sint Maarten',
      'FY':'French Guiana',
      'HP':'Panama','H3':'Panama','HO':'Panama',
      'TI':'Costa Rica','TE':'Costa Rica',
      'YN':'Nicaragua','HT':'Nicaragua','H7':'Nicaragua',
      'HR':'Honduras','HQ':'Honduras',
      'TG':'Guatemala','TD':'Guatemala',
      'YS':'El Salvador','HU':'El Salvador',
      'V3':'Belize',
      'CO':'Cuba','CM':'Cuba','CL':'Cuba','T4':'Cuba',
      'HI':'Dominican Republic',
      'HH':'Haiti','4V':'Haiti',
      '6Y':'Jamaica',
      'VP5':'Turks & Caicos Islands',
      'VP2E':'Anguilla','VP2M':'Montserrat','VP2V':'British Virgin Islands',
      'V2':'Antigua & Barbuda',
      'J3':'Grenada',
      'J6':'Saint Lucia',
      'J7':'Dominica',
      'J8':'Saint Vincent',
      'V4':'Saint Kitts & Nevis',
      '8P':'Barbados',
      'FM':'Martinique',
      'FG':'Guadeloupe',
      'FS':'Saint Martin',
      'FJ':'Saint Barthelemy',
      'VP9':'Bermuda',
      'ZF':'Cayman Islands',
      'C6':'Bahamas',
      'JA':'Japan','JB':'Japan','JC':'Japan','JD':'Japan','JE':'Japan',
      'JF':'Japan','JG':'Japan','JH':'Japan','JI':'Japan','JJ':'Japan',
      'JK':'Japan','JL':'Japan','JM':'Japan','JN':'Japan','JO':'Japan',
      'JP':'Japan','JQ':'Japan','JR':'Japan','JS':'Japan',
      '7J':'Japan','7K':'Japan','7L':'Japan','7M':'Japan','7N':'Japan',
      '8J':'Japan','8K':'Japan','8L':'Japan','8M':'Japan','8N':'Japan',
      'JD1':'Ogasawara',
      'HL':'South Korea','DS':'South Korea','DT':'South Korea','6K':'South Korea',
      '6L':'South Korea','6M':'South Korea','6N':'South Korea',
      'BV':'Taiwan','BW':'Taiwan','BX':'Taiwan','BM':'Taiwan','BN':'Taiwan',
      'BO':'Taiwan','BP':'Taiwan','BQ':'Taiwan',
      'B':'China','BA':'China','BB':'China','BC':'China','BD':'China',
      'BE':'China','BF':'China','BG':'China','BH':'China','BI':'China',
      'BJ':'China','BK':'China','BL':'China','BR':'China','BS':'China',
      'BT':'China','BU':'China','BY':'China','BZ':'China',
      '3W':'Vietnam','XV':'Vietnam',
      'HS':'Thailand','E2':'Thailand',
      '9M2':'West Malaysia','9M4':'West Malaysia','9M6':'East Malaysia','9M8':'East Malaysia',
      '9V':'Singapore',
      'YB':'Indonesia','YC':'Indonesia','YD':'Indonesia','YE':'Indonesia',
      'YF':'Indonesia','YG':'Indonesia','YH':'Indonesia',
      '7A':'Indonesia','7B':'Indonesia','7C':'Indonesia','7D':'Indonesia',
      '8A':'Indonesia','8B':'Indonesia','8C':'Indonesia','8D':'Indonesia',
      'DU':'Philippines','DV':'Philippines','DW':'Philippines','DX':'Philippines',
      'DY':'Philippines','DZ':'Philippines','4D':'Philippines','4E':'Philippines',
      '4F':'Philippines','4G':'Philippines','4H':'Philippines','4I':'Philippines',
      'VU':'India','VT':'India','VW':'India','8T':'India','8U':'India',
      '8V':'India','8W':'India','8X':'India','8Y':'India',
      'AP':'Pakistan','AQ':'Pakistan','AR':'Pakistan','AS':'Pakistan',
      '6P':'Pakistan','6Q':'Pakistan','6R':'Pakistan','6S':'Pakistan',
      '4S':'Sri Lanka',
      'S2':'Bangladesh',
      'XU':'Cambodia',
      'XW':'Laos',
      'XZ':'Myanmar',
      '9N':'Nepal',
      'A5':'Bhutan',
      'EX':'Kyrgyzstan',
      'EY':'Tajikistan',
      'EZ':'Turkmenistan',
      'UK':'Uzbekistan',
      'UN':'Kazakhstan','UL':'Kazakhstan','UM':'Kazakhstan','UP':'Kazakhstan',
      'UQ':'Kazakhstan',
      'EP':'Iran','EQ':'Iran',
      'YI':'Iraq','HN':'Iraq',
      'OD':'Lebanon',
      'YK':'Syria',
      '4X':'Israel','4Z':'Israel',
      'HZ':'Saudi Arabia','7Z':'Saudi Arabia',
      'A4':'Oman',
      'A6':'United Arab Emirates',
      'A7':'Qatar',
      'A9':'Bahrain',
      '9K':'Kuwait',
      'A2':'Botswana',
      'EK':'Armenia',
      '4J':'Azerbaijan','4K':'Azerbaijan',
      '4L':'Georgia',
      'T5':'Somalia',
      'SU':'Egypt','SS':'Egypt','6A':'Egypt','6B':'Egypt',
      '5A':'Libya',
      '7X':'Algeria',
      'CN':'Morocco','5C':'Morocco','5D':'Morocco',
      '3V':'Tunisia','TS':'Tunisia',
      'ST':'Sudan',
      'ET':'Ethiopia',
      '5Z':'Kenya',
      '5H':'Tanzania','5I':'Tanzania',
      '5X':'Uganda',
      '9U':'Burundi',
      '9X':'Rwanda',
      'TL':'Central African Republic',
      'TN':'Republic of the Congo',
      '9Q':'Democratic Republic of the Congo',
      'TR':'Gabon',
      'TJ':'Cameroon',
      'TT':'Chad',
      '5T':'Mauritania',
      '5U':'Niger',
      '5V':'Togo',
      'TU':'Ivory Coast',
      'TY':'Benin',
      'XT':'Burkina Faso',
      '6W':'Senegal',
      'EL':'Liberia',
      'C5':'The Gambia',
      'J5':'Guinea-Bissau',
      '3X':'Guinea',
      '9L':'Sierra Leone',
      '9G':'Ghana',
      'D4':'Cape Verde',
      '3C':'Equatorial Guinea',
      'S9':'Sao Tome & Principe',
      'V5':'Namibia',
      'ZS':'South Africa','ZR':'South Africa','ZT':'South Africa','ZU':'South Africa',
      '7P':'Lesotho',
      '3DA':'Eswatini',
      'Z8':'South Sudan',
      'E3':'Eritrea',
      'D6':'Comoros',
      '5R':'Madagascar',
      '3B8':'Mauritius','3B9':'Rodrigues Island',
      'FR':'Reunion Island',
      'FT':'French Southern Territories',
      'FH':'Mayotte',
      'VQ9':'Chagos Islands',
      'VK':'Australia','AX':'Australia',
      'VK9N':'Norfolk Island','VK9C':'Cocos (Keeling) Islands',
      'VK9X':'Christmas Island','VK9L':'Lord Howe Island',
      'VK0M':'Macquarie Island','VK0H':'Heard Island',
      'ZL':'New Zealand','ZM':'New Zealand',
      'ZL7':'Chatham Islands','ZL8':'Kermadec Islands','ZL9':'Auckland & Campbell Islands',
      'FK':'New Caledonia',
      'FO':'French Polynesia',
      'YJ':'Vanuatu',
      '3D2':'Fiji',
      'A3':'Tonga',
      '5W':'Samoa',
      'T3':'Kiribati',
      'V7':'Marshall Islands',
      'V6':'Micronesia',
      'T8':'Palau',
      'P2':'Papua New Guinea',
      'H4':'Solomon Islands',
      'T2':'Tuvalu',
      'ZK3':'Tokelau',
      'E5':'Cook Islands',
      'E6':'Niue',
      'ZK2':'Niue',
      'DP0':'Antarctica','RI1AN':'Antarctica',
      '1A':'Sovereign Military Order of Malta',
      '4U1U':'United Nations HQ',
    };

    const sortedPrefixes = Object.keys(prefixMap).sort((a, b) => b.length - a.length);

    function lookupCountry(callsign) {
      if (!callsign) return null;
      const baseCall = callsign.toUpperCase().trim().split('/')[0];
      for (const prefix of sortedPrefixes) {
        if (baseCall.startsWith(prefix)) return prefixMap[prefix];
      }
      return null;
    }

    // --- State ---
    const countries = new Map();
    let spotCount = 0;
    const totalCallsigns = new Set();
    let mqttClient = null;

    // --- DOM refs ---
    const countryGrid = document.getElementById('countryGrid');
    const feedList = document.getElementById('feedList');
    const emptyState = document.getElementById('emptyState');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const voiceMode = document.getElementById('voiceMode');
    const srAnnounce = document.getElementById('srAnnounce');
    const bandSelect = document.getElementById('bandSelect');
    const modeSelect = document.getElementById('modeSelect');

    // --- Persistence ---
    const savedMode = localStorage.getItem('voiceMode');
    if (savedMode) voiceMode.value = savedMode;
    const savedBand = localStorage.getItem('band');
    if (savedBand) bandSelect.value = savedBand;
    const savedModeFilter = localStorage.getItem('modeFilter');
    if (savedModeFilter) modeSelect.value = savedModeFilter;

    voiceMode.addEventListener('change', () => {
      localStorage.setItem('voiceMode', voiceMode.value);
      if (voiceMode.value === 'self-voice') speak('Voice enabled');
    });

    bandSelect.addEventListener('change', () => {
      localStorage.setItem('band', bandSelect.value);
      reconnect();
    });

    modeSelect.addEventListener('change', () => {
      localStorage.setItem('modeFilter', modeSelect.value);
      reconnect();
    });

    // --- Speech / Accessibility ---
    document.getElementById('testVoice').addEventListener('click', () => {
      announceCountry('Japan', 'JA1XYZ');
    });

    const speechQueue = [];
    let speechBusy = false;

    function speak(text) {
      speechQueue.push(text);
      if (!speechBusy) drainSpeechQueue();
    }

    function drainSpeechQueue() {
      if (speechQueue.length === 0) { speechBusy = false; return; }
      speechBusy = true;
      const text = speechQueue.shift();
      speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 1.2;
      utterance.pitch = 1.0;
      utterance.onend = () => drainSpeechQueue();
      utterance.onerror = () => drainSpeechQueue();
      speechSynthesis.resume();
      speechSynthesis.speak(utterance);
      setTimeout(() => {
        if (speechSynthesis.speaking) {
          speechSynthesis.cancel();
          drainSpeechQueue();
        }
      }, 10000);
    }

    setInterval(() => {
      if (speechSynthesis.paused) speechSynthesis.resume();
    }, 5000);

    function announceCountry(country, callsign) {
      const mode = voiceMode.value;
      const text = `${country}, ${callsign.split('').join(' ')}`;
      if (mode === 'self-voice') {
        speak(text);
      } else if (mode === 'screen-reader') {
        srAnnounce.textContent = '';
        setTimeout(() => { srAnnounce.textContent = text; }, 100);
      }
    }

    // --- UI ---
    function updateStats() {
      document.getElementById('countryCount').textContent = countries.size;
      document.getElementById('callsignCount').textContent = totalCallsigns.size;
      document.getElementById('messageCount').textContent = spotCount;
    }

    function renderCountryCard(name, data, highlight) {
      const safeId = 'country-' + name.replace(/[^a-zA-Z0-9]/g, '_');
      const existing = document.getElementById(safeId);
      if (existing) {
        existing.querySelector('.meta').innerHTML =
          `${data.callsigns.slice(-5).join(', ')} <span class="count">${data.count}</span>`;
        if (highlight) {
          existing.classList.add('highlight');
          setTimeout(() => existing.classList.remove('highlight'), 2000);
        }
        return;
      }

      if (emptyState.parentNode) emptyState.remove();

      const card = document.createElement('div');
      card.className = 'country-card' + (highlight ? ' highlight' : '');
      card.id = safeId;
      card.setAttribute('role', 'listitem');
      card.setAttribute('aria-label', `${name}, ${data.count} spots`);
      card.innerHTML = `
        <div class="name">${name}</div>
        <div class="meta">${data.callsigns.slice(-5).join(', ')} <span class="count">${data.count}</span></div>
      `;

      const cards = [...countryGrid.children];
      const insertBefore = cards.find(c => c.querySelector('.name')?.textContent > name);
      if (insertBefore) {
        countryGrid.insertBefore(card, insertBefore);
      } else {
        countryGrid.appendChild(card);
      }

      if (highlight) setTimeout(() => card.classList.remove('highlight'), 2000);
    }

    function addFeedItem(country, callsign, band, snr, timestamp) {
      const time = new Date(timestamp * 1000).toLocaleTimeString();
      const item = document.createElement('div');
      item.className = 'feed-item';
      item.innerHTML = `
        <div class="time">${time}</div>
        <div class="content">
          <span class="callsign">${callsign}</span> &rarr;
          <span class="country-name">${country}</span>
          <span class="band-tag">${band || ''}</span>
          ${snr != null ? `<span class="snr-tag">${snr}dB</span>` : ''}
        </div>
      `;
      feedList.insertBefore(item, feedList.firstChild);
      while (feedList.children.length > 200) {
        feedList.removeChild(feedList.lastChild);
      }
    }

    // --- Band to frequency range mapping for MQTT topic filtering ---
    const bandToFreq = {
      '160m': '1', '80m': '3', '60m': '5', '40m': '7', '30m': '10',
      '20m': '14', '17m': '18', '15m': '21', '12m': '24', '10m': '28',
      '6m': '50', '2m': '144'
    };

    // --- MQTT topic builder ---
    function buildTopic() {
      // pskr/filter/v2/{band}/{mode}/{senderCall}/{receiverCall}/{senderGrid}/{receiverGrid}/{senderCountry}/{receiverCountry}
      const band = bandSelect.value === 'all' ? '+' : bandSelect.value;
      const mode = modeSelect.value === 'all' ? '+' : modeSelect.value;
      return `pskr/filter/v2/${band}/${mode}/+/+/+/+/+/+`;
    }

    let currentTopic = null;

    function reconnect() {
      if (mqttClient && currentTopic) {
        mqttClient.unsubscribe(currentTopic);
      }
      // Clear state on band/mode change
      countries.clear();
      totalCallsigns.clear();
      spotCount = 0;
      countryGrid.innerHTML = '';
      feedList.innerHTML = '';
      const es = document.createElement('div');
      es.className = 'empty-state';
      es.id = 'emptyState';
      es.innerHTML = '<h3>Switching feed...</h3><p>Waiting for spots</p>';
      countryGrid.appendChild(es);
      updateStats();

      currentTopic = buildTopic();
      if (mqttClient && mqttClient.connected) {
        mqttClient.subscribe(currentTopic, (err) => {
          if (!err) {
            statusText.textContent = `Connected (${bandSelect.value} / ${modeSelect.value})`;
          }
        });
      }
    }

    // --- MQTT connection ---
    function connectMqtt() {
      statusText.textContent = 'Connecting...';

      mqttClient = mqtt.connect('wss://mqtt.pskreporter.info:1886');

      mqttClient.on('connect', () => {
        statusDot.classList.add('connected');
        currentTopic = buildTopic();
        mqttClient.subscribe(currentTopic, (err) => {
          if (err) {
            statusText.textContent = 'Subscribe error';
          } else {
            statusText.textContent = `Connected (${bandSelect.value} / ${modeSelect.value})`;
          }
        });
      });

      mqttClient.on('message', (topic, payload) => {
        try {
          const spot = JSON.parse(payload.toString());
          handleSpot(spot);
        } catch (e) {
          // ignore malformed
        }
      });

      mqttClient.on('error', (err) => {
        console.warn('MQTT error:', err);
        statusText.textContent = 'Connection error';
      });

      mqttClient.on('offline', () => {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Disconnected - reconnecting...';
      });

      mqttClient.on('reconnect', () => {
        statusText.textContent = 'Reconnecting...';
      });
    }

    // De-dupe by sequence number
    const seenSeqs = new Set();
    const MAX_SEEN = 5000;

    function handleSpot(spot) {
      // Fields: sc (sender call), rc (receiver call), f (freq), md (mode),
      //         b (band), t (timestamp), sl (sender grid), rl (receiver grid),
      //         rp (snr), sq (sequence)
      const callsign = spot.sc;
      if (!callsign) return;

      // De-dupe
      if (spot.sq) {
        if (seenSeqs.has(spot.sq)) return;
        seenSeqs.add(spot.sq);
        if (seenSeqs.size > MAX_SEEN) {
          const it = seenSeqs.values();
          for (let i = 0; i < 1000; i++) {
            seenSeqs.delete(it.next().value);
          }
        }
      }

      const country = lookupCountry(callsign);
      if (!country) return;

      spotCount++;
      totalCallsigns.add(callsign.toUpperCase());
      const isNewCountry = !countries.has(country);

      const existing = countries.get(country) || { count: 0, callsigns: [] };
      existing.count++;
      if (!existing.callsigns.includes(callsign.toUpperCase())) {
        existing.callsigns.push(callsign.toUpperCase());
      }
      existing.lastSeen = spot.t;
      countries.set(country, existing);

      renderCountryCard(country, existing, true);
      addFeedItem(country, callsign, spot.b, spot.rp, spot.t);
      updateStats();

      if (isNewCountry) {
        announceCountry(country, callsign);
      }
    }

    // --- Start ---
    connectMqtt();
  </script>
</body>
</html>
